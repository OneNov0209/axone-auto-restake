#!/bin/bash

# === Configuration ===
VALOPER="change_with_your_valoper_address"
WALLET="wallet"
CHAIN_ID="axone-1"
DENOM="uaxone"
FEE="500uaxone"
KEYRING="--keyring-backend test"

# === Telegram Bot Configuration ===
# Create your bot via https://t.me/BotFather
BOT_TOKEN="your_bot_token_here"
CHAT_ID="your_chat_id_here"

# === Telegram Notification Function ===
send_telegram() {
  MESSAGE=$1
  curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
    -d chat_id="$CHAT_ID" \
    -d text="$MESSAGE" \
    -d parse_mode="Markdown"
}

# === Start Process ===
echo "🚀 [$(date)] Starting AutoStake process"
send_telegram "🚀 *[Axone AutoStake]*\nStarting withdraw & re-stake process...\n⏰ Time: $(date -u +"%Y-%m-%d %H:%M UTC")"

# === Withdraw Rewards ===
WITHDRAW_OUTPUT=$(axoned tx distribution withdraw-rewards $VALOPER \
  --from $WALLET \
  --commission \
  --chain-id $CHAIN_ID \
  --gas auto \
  --gas-adjustment 1.4 \
  --fees $FEE \
  $KEYRING \
  -y 2>&1)
TXHASH_WITHDRAW=$(echo "$WITHDRAW_OUTPUT" | grep -oE '[A-F0-9]{64}' | head -n1)

# === Wait before redelegation ===
sleep 15

# === Get wallet balance ===
ADDRESS=$(axoned keys show $WALLET $KEYRING -a)
BALANCE=$(axoned query bank balances $ADDRESS --output json | jq -r '.balances[] | select(.denom=="uaxone") | .amount')

# === Balance validation ===
if [[ -z "$BALANCE" ]] || [[ "$BALANCE" -le 1000000 ]]; then
  send_telegram "⚠️ *[Axone AutoStake]*\nInsufficient balance for re-stake.\nRemaining balance: \`${BALANCE:-0} uaxone\`\n⏰ Time: $(date -u +"%Y-%m-%d %H:%M UTC")"
  exit 1
fi

# === Calculate delegate amount (leave 1 AXONE for gas) ===
DELEGATE_AMOUNT=$((BALANCE - 1000000))
AXONE_AMOUNT=$(echo "scale=4; $DELEGATE_AMOUNT / 1000000" | bc | sed "s/^\./0./")

# === Perform delegation ===
DELEGATE_OUTPUT=$(axoned tx staking delegate $VALOPER ${DELEGATE_AMOUNT}uaxone \
  --from $WALLET \
  --chain-id $CHAIN_ID \
  --gas auto \
  --gas-adjustment 1.4 \
  --fees $FEE \
  $KEYRING \
  -y 2>&1)
TXHASH_DELEGATE=$(echo "$DELEGATE_OUTPUT" | grep -oE '[A-F0-9]{64}' | head -n1)

# === Final Notification ===
TIME=$(date -u +"%Y-%m-%d %H:%M UTC")
send_telegram "✅ *[Axone AutoStake]*\n\n✅ *Withdraw* successful\n🔗 [TX Hash](https://explorer.onenov.xyz/axone-mainnet/tx/$TXHASH_WITHDRAW)\n\n✅ *Re-Stake* successful\n💰 Amount: \`${AXONE_AMOUNT} AXONE\`\n🔗 [TX Hash](https://explorer.onenov.xyz/axone-mainnet/tx/$TXHASH_DELEGATE)\n\n⏰ Date: $TIME\n✅ Status: *Success*"
